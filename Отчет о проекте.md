# Отчет о проекте Solid Social Network

Дата отчета: 28 февраля 2026
Проект: `social-network` (Laravel + Vue SPA)

## 1. Краткое описание проекта

`Solid Social Network` это полнофункциональная SPA-платформа социальной сети с упором на realtime-коммуникации и мультимедийные сценарии:

- социальная лента (посты, лайки, комментарии, репосты, просмотры),
- личные и общие чаты в реальном времени,
- IPTV модуль (direct/proxy/transcode/relay),
- онлайн-радио с избранным,
- админ-панель для управления контентом, пользователями, настройками и аналитикой,
- серверный heartbeat-трекинг пользовательской активности,
- мультиязычность RU/EN и SEO-оптимизация.

Проект подходит как коммерческий MVP/прототип для медиа-сообщества, так и как сильный pet-проект для техсобеседований.

## 2. Цель проекта и бизнес-логика

Основная цель: объединить в одном веб-продукте социальное взаимодействие и мультимедийный контент.

Ключевая бизнес-логика:

- Пользователь регистрируется, подтверждает email и получает доступ к основным функциям.
- Формирует профиль, публикует посты, подписывается на других пользователей.
- Общается в личных/глобальных чатах, обменивается вложениями, использует реакции.
- Слушает радио и смотрит IPTV в разных режимах в зависимости от качества канала и ограничений CORS.
- Администратор модерирует данные, управляет настройками хранения медиа и контентом главной страницы.

## 3. Функциональные модули

## 3.1 Социальная часть

- Пользователи, подписки, профиль, аватар.
- Посты с публичностью (`is_public`), показом в ленте (`show_in_feed`) и карусели (`show_in_carousel`).
- Медиа (изображения/видео), лайки, комментарии, репосты.
- Поддержка загрузки `jpg/jpeg/png/webp/gif/mp4/webm/mov/m4v/avi/mkv` до `200 MB` на файл.
- В личном кабинете реализована очередь загрузки пост-медиа с видимым прогрессом, статусами и текстом ошибок.
- Для длинных экранов добавлена глобальная кнопка возврата в начало раздела с адаптивным положением на desktop/mobile.
- Учет просмотров постов с дедупликацией по дню (1 просмотр в сутки на пользователя).

## 3.2 Realtime-чаты

- Типы чатов: `global`, `direct`, `archive`.
- Realtime-события через Reverb + Echo.
- Typing indicator, unread counters, реакции на сообщения.
- Вложения в сообщениях: image/video/gif/audio/file.
- Архивация/восстановление диалогов.
- Статус настроения (mood status) с гибкой видимостью.
- Блокировки пользователей влияют на direct chat и broadcast-доступ.

## 3.3 Радио

- Поиск станций через Radio Browser API.
- Прокси-стрим через backend endpoint.
- Избранные станции пользователя.
- Доп. команда для одноразового распределения избранного админов всем не-админам.

## 3.4 IPTV

- Импорт плейлистов (M3U/M3U8) по URL.
- Библиотека сохраненных плейлистов и каналов.
- Режимы просмотра:
  - Direct,
  - Proxy,
  - Transcode (FFmpeg),
  - Relay.
- Защита URL и анти-SSRF проверки.
- TTL/лимиты сессий и очистка.

## 3.5 Админ-панель

- Управление пользователями, правами администратора.
- Управление постами, комментариями, лайками.
- Модерация обратной связи.
- Управление чатами, сообщениями, блокировками.
- Настройки сайта и home-контента (RU/EN).
- Дашборд аналитики с KPI и годовыми/месячными графиками по модулям.
- Выбор фактического диапазона дат в админке (`date_from/date_to`) и расчет статистики по выбранному периоду.
- Расширенные блоки аналитики: `retention`, `content efficiency`, `chats`, `media/video`, `radio`, `IPTV`, `errors/moderation`.
- Выгрузка аналитики дашборда в `Excel (.xls)` и `JSON` с отдельными секциями `Summary`, `Retention`, `Content`, `Chats`, `Media`, `Radio`, `IPTV`, `Errors / Moderation`.
- IPTV seed-источники.

## 3.6 Серверная аналитика активности (heartbeat)

- Endpoint `POST /api/activity/heartbeat` для отслеживания активных сессий пользователя по feature (`social/chats/radio/iptv`).
- Endpoint `POST /api/analytics/events` для client-side событий (`video_session`, `media_upload_failed`, `radio_play_*`, `iptv_*`).
- Хранение сессий в `user_activity_sessions`.
- Дневная агрегация в `user_activity_daily_stats` для аналитических отчетов.
- Хранение клиентских событий в `analytics_events` для media/radio/IPTV/video аналитики и export.
- Автоматическое переключение метода расчета интересов на time-based (`time_minutes`) при наличии heartbeat-данных.

Референс по формулам, источникам таблиц, алгоритмам fallback и ручной проверке:

- `docs/analytics-metrics.md`

Ключевые правила:

- `summary` использует прямые `COUNT(*)` из бизнес-таблиц;
- `dashboard/export` используют один и тот же payload из `AdminDashboardService`;
- heartbeat-таблицы имеют приоритет над action-based fallback;
- media/radio/IPTV/video метрики зависят от `analytics_events`;
- cohort retention помечается `partial`, если 30-дневное окно ещё не завершено.

## 4. Технологический стек

Backend:

- `PHP ^8.2` (Docker-образ на `PHP 8.3`)
- `Laravel 10`
- `Laravel Sanctum`
- `Laravel Reverb`
- `l5-swagger`

Frontend:

- `Vue 3`
- `Vue Router`
- `Axios`
- `Vite 7`
- `Tailwind CSS 4`
- `hls.js`, `dash.js`, `mpegts.js`, `plyr`

Infra/DevOps:

- `Docker Compose`
- `Nginx`
- `MySQL 8.4`
- `FFmpeg`

## 5. Архитектура проекта

## 5.1 Высокоуровневая схема

1. Browser (Vue SPA) отправляет HTTP API запросы к Laravel.
2. Авторизация и сессии работают через Sanctum cookie + CSRF.
3. Realtime-события идут через Reverb WebSocket (`/app`, `/apps`).
4. IPTV/Radio проксируются и валидируются на сервере.
5. Данные хранятся в MySQL, файлы в filesystem disk (`public/s3` и т.д.).

## 5.2 Backend архитектура

- `routes/api.php`: основной API.
- `routes/web.php`: SPA fallback и auth routes.
- `routes/channels.php`: авторизация broadcast-каналов.
- `app/Http/Controllers`: тонкие контроллеры по доменам.
- `app/Services`: бизнес-логика (IPTV, настройки, посты, world overview).
- `app/Models`: Eloquent-модели и связи.
- `app/Rules/NoUnsafeMarkup`: анти-XSS валидация текстового контента.

## 5.3 Frontend архитектура

- SPA entrypoint: `resources/js/app.js`.
- Router: локализованные маршруты `/:locale(ru|en)?`.
- Guards: auth/guest/email-verified/admin.
- Runtime i18n для legacy-текста в DOM.
- Крупные страницы:
  - `resources/js/views/Home.vue`
  - `resources/js/views/user/Chats.vue`
  - `resources/js/views/user/Iptv.vue`
  - `resources/js/views/user/Radio.vue`
  - `resources/js/views/user/Admin.vue`
- Крупные компоненты:
  - `resources/js/components/widgets/PersistentChatWidget.vue`
  - `resources/js/components/IptvPlayer.vue`
  - `resources/js/components/widgets/PersistentRadioWidget.vue`

## 6. Модель данных (основные сущности)

Пользователи и социальный граф:

- `users`
- `subscriber_followings`
- `user_blocks`

Контент:

- `posts`
- `post_images`
- `liked_posts`
- `comments`
- `post_views`

Чаты:

- `conversations`
- `conversation_participants`
- `conversation_messages`
- `conversation_message_attachments`
- `conversation_message_reactions`
- `conversation_mood_statuses`
- `user_chat_settings`
- `chat_archives`

Поддержка и админ-модули:

- `feedback_messages`
- `site_settings`
- `user_activity_sessions`
- `user_activity_daily_stats`
- `analytics_events`
- `radio_favorites`
- `iptv_seeds`
- `iptv_saved_playlists`
- `iptv_saved_channels`

## 7. Безопасность проекта

Что реализовано:

- Sanctum stateful auth + middleware `auth:sanctum`.
- Ограничение критичных API через `verified` (подтвержденный email).
- Роль администратора через middleware `admin`.
- CSRF-защита и автоматический refresh XSRF-cookie на 419.
- CORS белый список через `CORS_ALLOWED_ORIGINS`.
- Route-level rate limiting API:
  - авторизованные API: `throttle:600,1`,
  - публичные `site/home-content` и `site/world-overview`: `throttle:240,1`,
  - feedback anti-spam: `throttle:20,1`,
  - media (`post-images`, `avatars`): `throttle:600,1`,
  - heartbeat endpoint: `throttle:120,1`,
  - client analytics endpoint: `throttle:240,1`,
  - email verification notification: `throttle:6,1`.
- `NoUnsafeMarkup` блокирует HTML/script/inline handlers/опасные схемы.
- Upload-валидация пост-медиа использует приоритет серверного `MIME`/`Fileinfo`; клиентский `MIME` учитывается только как fallback для контейнеров вроде `mkv`.
- Файлы, замаскированные под видео, но распознанные сервером как не-media, отклоняются до сохранения.
- Защита медиа-доступа (проверка владельца/публичности/админ-прав).
- Защита broadcast channels (включая проверку блокировок).
- Анти-SSRF для IPTV/Radio URL (localhost/private/reserved блокируется).
- Ограничения и TTL на proxy/transcode/relay сессии.

Рекомендации для production-усиления:

- Перейти на `SESSION_SECURE_COOKIE=true` и HTTPS-only.
- Добавить WAF/Cloudflare и централизованный rate limiting на edge.
- Подключить централизованные логи и алерты (Sentry + Loki/ELK).
- Добавить антивирусную проверку файловых вложений на upload.

## 8. Поддержка и эксплуатация

Локальный запуск (без Docker):

```powershell
Copy-Item .env.example .env
composer install
npm ci
php artisan key:generate
php artisan migrate --seed
php artisan storage:link
php artisan serve
npm run dev
php artisan reverb:start --host=0.0.0.0 --port=6001
```

Docker запуск:

```powershell
docker compose up -d --build
docker compose ps
```

Полезные команды:

```powershell
docker compose exec --user=www-data app php artisan migrate --seed
docker compose exec --user=www-data app php artisan test
docker compose exec --user=www-data app php artisan db:seed --class=DemoSocialContentSeeder
docker compose --profile test run --rm --no-build test
docker compose logs --tail=100 app
docker compose down
```

Production деплой описан в `DEPLOY.md` (Nginx + PHP-FPM + Supervisor + Reverb).

## 9. Тестирование и качество

В проекте есть широкое Feature-покрытие:

- `ChatFeatureTest`
- `BroadcastChannelsFeatureTest`
- `IptvFeatureTest`
- `RadioFeatureTest`
- `AdminPanelFeatureTest`
- `ActivityHeartbeatFeatureTest`
- `DemoSocialContentSeederFeatureTest`
- `ApiRateLimitFeatureTest`
- `LoginThrottleFeatureTest`
- `MediaPostFeatureTest`
- `ApiSecurityRefactorTest`
- `SiteSettingsAndDiscoveryFeatureTest`
- и др.

Ключевые проверяемые зоны:

- авторизация/права доступа,
- блокировки и broadcast security,
- валидация пользовательского ввода и анти-XSS,
- IPTV/Radio сценарии и ошибки внешних источников,
- админские операции, очистки и модерация.
- heartbeat-трекинг и time-based аналитика дашборда.
- client analytics endpoint и агрегирование media/radio/IPTV/video событий в дашборде.
- валидация диапазона дат и экспорт аналитики (`/api/admin/dashboard/export`) в `xls/json`.
- отдельный документ `docs/analytics-metrics.md` с формулами, источниками данных, fallback-логикой и командами ручной верификации.

Дополнительно для frontend helper-логики:

- `npm run test:js` (unit-тесты helper-логики радио, IPTV, поиска по карусели авторов и кнопки возврата в начало).
- `php artisan test tests/Feature/SwaggerDocumentationFeatureTest.php` (генерация Swagger/OpenAPI, наличие ключевых маршрутов, включая client analytics/admin export, и доступность UI).

Результаты полного прогона тестов (28 февраля 2026):

- `php artisan test`: `196 passed`, `1681 assertions`.
- `npm run test:js`: `33 passed`.
- `npm audit`: `0 vulnerabilities`.
- `composer audit --format=json`: `0 advisories` (при этом `doctrine/annotations` остается `abandoned` транзитивной зависимостью через `l5-swagger`; это maintenance-сигнал без security advisory, но команда может вернуть non-zero exit code).

Актуализация тестового bootstrap:

- В `tests/CreatesApplication.php` добавлена ранняя фиксация `testing`-переменных окружения до bootstrap приложения.
- Тестовый `storage/cache` изолируется по `TEST_TOKEN` (per-process), что устраняет конфликты прав и артефактов между Docker-запусками от `root` и `www-data`.

## 10. Расширяемость проекта

Где расширять систему:

- Новый backend-модуль:
  1. Controller + FormRequest
  2. Service слой (бизнес-логика)
  3. Model + migration
  4. Routes + tests
- Новый realtime-сценарий:
  1. Event implements ShouldBroadcastNow
  2. Channel authorization
  3. Echo подписка на фронте
- Новый frontend-раздел:
  1. `resources/js/views/...`
  2. Router route + guard
  3. API слой на axios
  4. i18n ключи RU/EN

Почему проект хорошо расширяется:

- код разделен по доменам,
- бизнес-логика вынесена в сервисы,
- покрытие feature-тестами снижает риск регрессий,
- есть Docker и production-guide для стабильного жизненного цикла.

## 11. Как создать похожий проект с нуля

Ниже практический путь, который повторяет архитектурные решения этого проекта.

## 11.1 Подготовка окружения

Минимум:

- PHP 8.2+
- Composer 2+
- Node.js 22+ и npm
- MySQL 8+
- Git
- FFmpeg (для transcode/relay режима)

## 11.2 Создать папку и Laravel-проект

PowerShell:

```powershell
mkdir C:\OSPanel\home\social-network-new
cd C:\OSPanel\home\social-network-new
composer create-project laravel/laravel .
```

Bash:

```bash
mkdir -p ~/projects/social-network-new
cd ~/projects/social-network-new
composer create-project laravel/laravel .
```

## 11.3 Установить backend-пакеты (как в текущем проекте)

```bash
composer require laravel/sanctum laravel/reverb pusher/pusher-php-server
composer require darkaonline/l5-swagger guzzlehttp/guzzle doctrine/dbal
composer require laravel/ui
```

## 11.4 Установить frontend-пакеты

```bash
npm install vue vue-router axios laravel-echo pusher-js
npm install hls.js dashjs mpegts.js plyr
npm install -D vite laravel-vite-plugin @vitejs/plugin-vue tailwindcss @tailwindcss/postcss postcss autoprefixer
```

## 11.5 Настроить `.env`

```dotenv
APP_URL=http://localhost:8000
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=social_network
DB_USERNAME=root
DB_PASSWORD=

BROADCAST_DRIVER=pusher
SANCTUM_STATEFUL_DOMAINS=localhost,127.0.0.1,localhost:5173,127.0.0.1:5173
CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173

REVERB_APP_ID=local-app-id
REVERB_APP_KEY=local-app-key
REVERB_APP_SECRET=local-app-secret
REVERB_HOST=127.0.0.1
REVERB_PORT=6001
REVERB_SCHEME=http
REVERB_SERVER_HOST=0.0.0.0
REVERB_SERVER_PORT=6001

IPTV_FFMPEG_BIN=ffmpeg
```

## 11.6 Базовая инициализация

```bash
php artisan key:generate
php artisan migrate
php artisan storage:link
```

## 11.7 Реализовать auth + SPA

1. Добавить маршруты auth (например через `laravel/ui` или собственный SPA flow).
2. Подключить Vue-приложение через Vite.
3. Сделать SPA fallback route в `web.php`.
4. Настроить axios:
  - `withCredentials=true`
  - `xsrfCookieName`
  - retry на 419 через `/sanctum/csrf-cookie`.

## 11.8 Реализовать домены по этапам

Этап 1:

- Users/Profile/Following.
- Posts/Likes/Comments/Reposts.

Этап 2:

- Conversations/Messages/Reactions.
- Reverb events + channels auth.

Этап 3:

- Radio search + favorites + stream proxy.
- IPTV import + saved library + proxy mode.

Этап 4:

- IPTV transcode/relay через FFmpeg.
- Admin panel + site settings + RU/EN контент.

## 11.9 Запуск проекта

Backend:

```bash
php artisan serve
```

Frontend:

```bash
npm run dev
```

Realtime:

```bash
php artisan reverb:start --host=0.0.0.0 --port=6001
```

## 11.10 Docker-версия (рекомендуется)

1. Создать `docker-compose.yml` с сервисами `app`, `web`, `db`, `websocket`, `frontend-build`.
2. В `app` образ установить PHP ext + FFmpeg + Composer.
3. В entrypoint:
  - `composer install`,
  - `php artisan migrate`,
  - `storage:link`,
  - проверка `IPTV_FFMPEG_BIN`.
4. Запуск:

```bash
docker compose up -d --build
```

## 11.11 Минимум для production

1. Nginx + PHP-FPM.
2. Supervisor process для `php artisan reverb:start`.
3. HTTPS + secure cookies.
4. `php artisan config:cache && route:cache`.
5. Бэкапы БД + мониторинг.



## 12. Потенциальные следующие улучшения

- Redis для кеша, очередей и масштабирования realtime.
- Horizontal scaling Reverb + sticky sessions.
- Отдельный CDN/S3 lifecycle policy для медиа.
- Full observability (метрики, distributed tracing, error budget).
- E2E тесты (Playwright/Cypress) поверх существующих feature-тестов.

---

Итог: Документация и архитектура уже позволяют поддерживать и развивать систему как продукт, а не только как учебный pet-проект.
